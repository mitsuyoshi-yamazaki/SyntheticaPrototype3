## このファイルについて

- 本ファイルはゲームの要件と仕様について記載している
- **本ファイルは、ゲーム本体の仕様と実装を考える際の材料とするためのプロトタイプ仕様である**
- 本ファイルに記載の用語については、日本語の後に[]でソフトウェア上で表記する名前を記載する

## Claudeへの指示

- ゲームの要件と仕様を更新した際は本ファイルの内容も追従させること

## 仕様バージョン

- **現在のバージョン**: 5.0.0
- **バージョニング方式**: Semantic Versioning x.y.z
  - x: MAJOR: 後方互換性のない変更
  - y: MINOR: 後方互換性のある機能追加
  - z: PATCH: 後方互換性のあるバグ修正
- **変更履歴**:
  - 5.0.0 (2025-10-06): バージョン作成

### v5仕様の概要とゴール

- 仕様のゴール：できる限り単純な実装によって、基本的なアイデアを実現できること
- COMPUTERの実行するソフトウェアはJS Interpreterで実現する
- 本バージョンのゴールは、自己複製と進化が可能なエージェントを、複数種類作成できるシミュレーション系を作成することと、それをwebページ上で操作可能な状態でホスティングすることである
- ユニットの独立性は、単純化のために本仕様からは外し、エージェントを単位として存在するようにする

## ゲーム要件

`docs/requirements.md` を参照

## ゲーム仕様

### 世界[World]

- 世界は上下左右がループした二次元トーラス形状をとる
- ゲームの空間（正確には平面であるが、空間と呼称する）は正方形のセル[Cell]に分割されており、空間に作用する現象（現状では熱のみ）は個々のセルに対して作用する
- ゲームの時間は離散的である。各tickにゲームオブジェクト物理演算とエージェントの動作処理が行われ、その結果が次tickに反映される

### "実際のゲーム世界"

_"実際のゲーム世界"のセクションはアプリケーションの仕様には影響しない、仕様策定の際のフレーバー背景である_

- このゲームは、ゲーム内の物理法則として、質量の保存則やエントロピーの法則をもつ
- このゲームの仕様としてそれらの法則に例外があるように見える（エネルギーソースからエネルギーが無限に湧き出す、熱が時間経過で減っていく、等）のは、アプリケーション上に表現されるこのゲームの空間は、"実際のゲーム世界"の"高さ"方向の一断面に過ぎないためである
  - このゲームの空間は、"実際のゲーム世界"の中での局所的にエントロピーが減少する一部分を切り取ったものである
  - その解釈に基づくと、エネルギーソースは"実際のゲーム世界"からのエネルギー供給、放熱は"実際のゲーム世界"の高さ方向へ熱が拡散していく現象である、と解釈される
  - これは現実世界における以下の現象との対応で理解できる
    - このゲームの空間：地球（太陽から供給されるエネルギーによる局所的なエントロピーの減少）
    - エネルギーソース：太陽
    - 放熱：宇宙空間への放熱

### ゲームオブジェクト[GameObject]

- ゲーム空間上に存在する物体のことをゲームオブジェクトと呼称する
- ゲームオブジェクトは以下のプロパティをもつ
  - 位置[Position]
    - 位置は連続数値で表される
    - セルから何らかの影響を受ける場合、ゲームオブジェクトに影響を与えるセルは、そのオブジェクト位置を含むセルである
  - 形状[Shape]
    - 形状は全てのオブジェクトで円形である
  - 大きさ[Radius]
    - 大きさは全て半径のことである
  - 重量[Weight]
    - 重量は、そのゲームオブジェクトにかかる力がどれだけの加速度をもたらすかに影響する
  - 速度[Velocity]
    - そのゲームオブジェクトが現在もっている速度
  - 加速度[Acceleration]
    - そのゲームオブジェクトにかかっている加速度
    - このパラメータは永続化されず、次tickのオブジェクトの速度を求めることにのみ利用される
- 仕様
  - 衝突[Collision]
    - ゲームオブジェクト同士は衝突しない（すり抜ける）

### tickの処理

- tickの処理順（tick t）：
  1. **エージェントアクションフェーズ**
  - エージェントの操作対象となるのはt-1 tickの世界の状態である
    1-1. 予約されたアクションのためのエネルギーを確保する（確保順序：`energy-action-order.md`参照）（オブジェクトの移動に関する操作は、操作が予約された状態となり、 2. 物理演算フェーズ で移動を行う）
    1-2. 予約されたアクションを実行する（実行順序：`energy-action-order.md`参照）ただし、COMPUTERのソフトウェア実行は 5. COMPUTER実行フェーズ で行う（t時点の世界の状態を確定させた後にソフトウェアを実行する）
  2. **物理演算フェーズ**
     2-1. 各オブジェクトの位置の更新（`object-position-update.md`参照）
  3. **環境処理フェーズ**
     3-1. エネルギーソースからエネルギー生成（`energy-source-specification.md`参照）
     3-2. エネルギーの自然崩壊処理（`energy-decay-specification.md`参照）
  4. **熱処理フェーズ**
     4-1. 熱拡散計算（`heat-diffusion-system.md`参照）
     4-2. 熱放熱計算（`heat-diffusion-system.md`参照）
     4-3. 環境ダメージ判定・適用
  5. **COMPUTERソフトウェア実行フェーズ**
     5-1. ソフトウェア実行および次tick用アクション予約受付

- アクション予約制：
  - 全てのエージェントの操作は「次のtickで行うアクションを予約する」形で指示される
  - COMPUTERのソフトウェア実行時にアクション予約が行われる

### 熱[Heat]

- 空間のセルは熱の値をもち、熱はゲームオブジェクトに影響を与える
- 挙動
  - 熱の値はエネルギーの消費等、世界とゲームオブジェクトのさまざまな活動によりセルに加算される
    - これはこの世界におけるエントロピーを表現している
  - 熱の値は隣接セルの間で均衡するように移動する。この計算時は熱の総量は増減しない（この計算後、後述の放熱の計算により熱の総量は減少する）
  - セルの熱の値は時間経過で減ってゆく
    - これは放熱を表現している
  - 熱拡散・放熱の詳細：`heat-diffusion-system.md`参照
- 後述の資源やユニットはそれ自体は熱の値を持たず、配置されているセルの熱の値により熱の影響を受ける
- 熱ダメージ仕様：
  - 熱により受けるダメージは各オブジェクト種別、各ユニット種別により異なる _TODO_

#### エネルギー[Energy]

- エネルギーは、現実世界の資源やエネルギーに相当するゲームオブジェクトである。ゲーム世界においては、構造材料及びエネルギーの両方の性質をもつ
- エネルギーはゲームオブジェクトである。つまり、ゲーム世界上に物体として存在する
- エネルギーはエネルギーソースから、ソースごとに定められたエネルギー算出量と算出間隔に応じて生成される（世界に新たに追加される）
  - エネルギーの出現：
    - エネルギーソースの座標に、速度をもって出現する
  - 詳細仕様：`energy-source-specification.md`参照
- 資源の分解や合成、エージェントの移動やCOMPUTERの計算処理など、全ての活動はエネルギーを消費する。消費されたエネルギーは完全に消滅するが、消費されたエネルギー量に比例した熱をその場所に加える
- エネルギーの自然崩壊：
  - 未使用のエネルギーオブジェクトは時間経過により自然に崩壊し、熱に変換される
  - 崩壊量 = `ceil(sqrt(エネルギー量) / 10)` E/tick
  - 崩壊により発生した熱は、エネルギーオブジェクトが存在するセルに加算される
  - この仕様により、エネルギーが無限に蓄積することを防ぎ、エントロピー増大の法則を表現する
- エネルギーの分解効率[Disassemble efficiency]
  - エネルギーには分解効率のパラメータがあり、エージェントがエネルギーを分解吸収する際に実際にエネルギーとして取り込める量は、この分解効率をかけた値となる
- 本仕様書を含め、エネルギーの量を記載する際に数値に `E` をつけて `5E`, `123E` （それぞれエネルギーが5単位、123単位）と表記する

### エージェント[Agent]

- エージェントとは、その仕様に従って能動的に活動するゲームオブジェクトである
- エージェントは生まれつき以下の機能[Function]をもち、それぞれの機能の発現力[Power]に応じて、その機能がを実行した際の影響の大きさが決まる。発現力が0であれば機能を発現しても何も起きない

### エージェント機能[Function]

#### Hull[Hull]

- エージェントを外部環境から区切る、細胞膜の役割をもつ
- パラメータ：
  - 容量：エージェントに格納できるエネルギーの容量
  - アクセスコントロール：そのエージェントの機能に別エージェントがアクセスできるかどうか
    - memo: connectした最小のエージェントに仕事を割り振ることができるのではないか
  - memo: hullは分解効率が低く、内部は分解効率が高い

#### Compute[Compute]

- ソフトウェアを実行する
- パラメータ：
  - 実行速度（tickあたりの実行命令数）
  - プログラム容量（実行するプログラムの容量）

#### Assemble[Assemble]

- パラメータ：
  - Assemble Power（tickあたりの生成/修理量）

#### Disassemble[Disassemble]

- パラメータ：
  - Disassemble Power（tickあたりのダメージ量）
- 機能
  - Disassemble
    - Connectした対象をdisassembleする
      - エネルギーであれば、

#### Connect[Connect]

**廃止** ：物理演算を単純化するため しかし接続やエネルギーの受け渡しがあった方が振る舞いの自由度が高いのは確か

- パラメータ：
  - Number of Connectors（同時に幾つのオブジェクトと接続できるか）

#### Move[Move]

- パラメータ：
  - Move Power（tickあたりに発生させられる力の上限）

#### Sense[Sense]

- パラメータ：
  - 範囲（自身を中心にした知覚範囲）

---

- （仕様策定時の方針）処理順の計算を簡便にするため、また現実世界のアクションは全て逐次的に起きることを参考に、何かのアクションが失敗する場合は、「そのアクションが行われなかったことにする」のではなく、「そのアクションを行なったが失敗した」、という状況になるようにする
  - 例：assembleに必要なエネルギーは確保できたが、assemble対象を設置できないとなった場合、「エネルギーが消費されなかったことにする」のではなく、「エネルギーを消費して設置を試みたが、結果として設置はされなかった（エネルギーは消費される）」とする

## TBD

- 物理法則
  - 物理法則は入れ替えができるように実装上隔離しておく
  - 摩擦は物理法則とゲームオブジェクトの物性、ゲームオブジェクトの重さの掛け合わせで決まる
    - エネルギーオブジェクトの摩擦を小さくしたいため
    - 速度の大きさに比例して摩擦が大きくなるような仕組みを入れることで、速度を制限しつつある程度の速度は出るようにできるか

## MEMO

- 熱によりダメージが入り、エネルギーが放出されるということは、ある程度以上の熱量をもつセルに大きな物体が乗った場合、加速度的に加熱される燃焼現象が発生するのではないか
- 有性生殖や同種の判別に使えるような情報のやり取り
  - 案：外部読み取り可能な状態で、非活性で安価なエージェントに情報を詰めて放流する
- エネルギーを一度に消費する量によりロス（ロスは熱になる）の発生割合が変わるなど
- エネルギーに変換効率というプロパティを追加すれば、ひとつの資源で様々な性質を表現できるのではないか
  - 生成されたばかりのエネルギーは最高の変換効率
  - 変換ロスで排出されるものは変換効率が低い
  - 死んだエージェントが変化したエネルギーは変換効率が高い
- 生態
  - 現状の仕様では「成長」はない
  - エネルギー塊に接続させる最小構成の娘個体に完全体を産ませる
  - assembleを高速化するための補助個体を産ませる（接続したエネルギー塊から近所のconstruction siteを構築するだけ：エージェント間のエネルギー受け渡しができるならば親個体にくっついていればいいのでは）
  - エネルギー塊を発見するためのworker（どのように実現するか？）
  - connectを切るためのアーマーの役割としての娘個体

## TODO

- コミュニケーションの方法を考える
  - フェロモンに例えられる、広範囲に小さな情報量を伝える通信
    - （フェロモン様の仕組みを導入したとして）情報自体は送信したものをそのまま受け取れる仕組みにしても、他の雑多な匂いの中からあるひとつの情報を拾い上げるのは困難で、そこにノイズが出る
  - 有性生殖の配偶子に例えられる、特定の他者に大きな情報を伝える通信
    - エージェントを生成して、その情報を外部読み取り可能な状態にしておく？
- 「ユニット」は廃止したため削除する

## 将来追加する仕様

- 本仕様バージョン内で、本仕様の本質的な将来的に追加可能

### 衝突[Collision]
