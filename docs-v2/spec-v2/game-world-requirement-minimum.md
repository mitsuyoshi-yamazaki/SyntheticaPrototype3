## このファイルについて

- 本ファイルはゲームの要件と仕様について記載している
- **本ファイルは、ゲーム本体の仕様と実装を考える際の材料とするためのプロトタイプ仕様である**
- 本ファイルに記載の用語については、日本語の後に[]でソフトウェア上で表記する名前を記載する

## Claudeへの指示

- ゲームの要件と仕様を更新した際は本ファイルの内容も追従させること

## ゲーム要件

- このゲームは、プレイヤーが作成したエージェントを環境中に放って自律行動するのを観察するMMOゲームである
  - このゲームの目的は、オープンエンドな進化を、①十分に一貫した自由度の高いシミュレーション系のうえで、②人間に競争させることでオープンエンド性を付与する ことで実現するものである（※ 人間が競争する際に発揮する創造性はオープンエンドであるという仮定のもと進める）
- エージェントは全て自律的に動作し、環境中の資源を回収・代謝して自己を拡張・修復・複製する
- エージェントの身体は資源回収、移動、アセンブリ、情報処理など複数の種類のユニットを組み合わせて成り立つ
- プレイヤーはこのエージェントの身体部分を定義するとともに、頭脳ユニットで実行するソフトウェアを作成することでエージェントを作成する
- このゲームの独自性は、地球上に存在するものも存在しないものも含めて、任意の生態を持つエージェントを作成・繁殖できる場を提供することを目的とする

## ゲーム仕様

### 世界[World]

- 世界は上下左右がループした二次元トーラス形状をとる
- ゲームの空間（正確には平面であるが、空間と呼称する）は正方形のセル[Cell]に分割されており、空間に作用する現象（現状では熱のみ）は個々のセルに対して作用する
  - 一方でゲームオブジェクトの移動はセルとは無関係に、連続値の座標を取る
- ゲームの時間は離散的である。各tickにゲームオブジェクト物理演算とユニットの動作処理が行われ、その結果が次tickに反映される

### "実際のゲーム世界"

_"実際のゲーム世界"のセクションはアプリケーションの仕様には影響しない、仕様策定の際のフレーバー背景である_

- このゲームは、ゲーム内の物理法則として、質量の保存則やエントロピーの法則をもつ
- このゲームの仕様としてそれらの法則に例外があるように見える（エネルギーソースからエネルギーが無限に湧き出す、熱が時間経過で減っていく、等）のは、アプリケーション上に表現されるこのゲームの空間は、"実際のゲーム世界"の"高さ"方向の一断面に過ぎないためである
  - このゲームの空間は、"実際のゲーム世界"の中での局所的にエントロピーが減少する一部分を切り取ったものである
  - その解釈に基づくと、エネルギーソースは"実際のゲーム世界"からのエネルギー供給、放熱は"実際のゲーム世界"の高さ方向へ熱が拡散していく現象である、と解釈される
  - これは現実世界における以下の現象との対応で理解できる
    - このゲームの空間：地球（太陽から供給されるエネルギーによる局所的なエントロピーの減少）
    - エネルギーソース：太陽
    - 放熱：宇宙空間への放熱

### ゲームオブジェクト[GameObject]

- ゲーム世界上に存在する物体のことをゲームオブジェクトと呼称する
- ゲームオブジェクトは以下のプロパティをもつ
  - 位置[Position]
    - 位置は（離散的なグリッド上に置かれるのではなく）連続的数値で表される
  - 大きさ、形状
  - 速度[Velocity]
    - 速度は前tickにそのゲームオブジェクトに加わった加速度により増減する
  - 加速度[Acceleration]
  - 重量[Weight]
    - 重量はゲームオブジェクトにかかった力がどれだけの加速度を生むかに影響する
- 仕様
  - 衝突[Collision]
    - 複数のゲームオブジェクトが同時に同じ空間の一点に存在することは禁止したいが、計算処理を容易にするため、完全に禁止はせずに以下の仕様で実装する
      - 重なった複数の物体は共通重心から離れる方向へ力（反発力[Separation Force]）を受ける（ことにより、物体の重なりを時間経過で解消する）
  - 隣接[Adjacent]
    - ふたつのオブジェクトが"隣接"している状態とは以下のどれかの状態である
      - 双方がユニットであり、接続している状態
      - ふたつのオブジェクトが"隣接距離"以下の間隔で隣り合っている状態
        - 両方がHULLの中にいる場合は常に隣接状態
        - HULLとそのHULLの内容物は常に隣接状態

### 熱[Heat]

- 空間のセルは熱の値をもち、熱はゲームオブジェクトに影響を与える
- 挙動
  - 熱の値はエネルギーの消費等、世界とゲームオブジェクトのさまざまな活動によりセルに加算される
    - これはこの世界におけるエントロピーを表現している
  - 熱の値は隣接セルの間で均衡するように移動する。この計算時は熱の総量は増減しない（この計算後、後述の放熱の計算により熱の総量は減少する）
  - セルの熱の値は時間経過で減ってゆく
    - これは放熱を表現している
- 後述の資源やユニットはそれ自体は熱の値を持たず、配置されているセルの熱の値により熱の影響を受ける
  - 資源やユニットは大きさをもつので複数のセルにまたがる位置に存在することがあるが、受ける熱の影響は、ユニットの座標が含まれるセルの熱の値である
    - この仕様は基本的にはゲーム世界の法則の一貫性を崩すが、プロトタイプであるので実装の簡便さと法則の一貫性の間をとってこの仕様とする

#### エネルギー[Energy]

- エネルギーは、現実世界の資源やエネルギーに相当するゲームオブジェクトである。ゲーム世界においては、構造材料及びエネルギーの両方の性質をもつ
- エネルギーはエネルギーソースから、ソースごとに定められたエネルギー算出量に応じて、毎tick生成される（世界に新たに追加される）
- 資源の分解や合成、エージェントの移動やCOMPUTERの計算処理など、全ての活動はエネルギーを消費する。消費されたエネルギーは完全に消滅するが、消費されたエネルギー量に比例した熱をその場所に加える
- エネルギーはゲームオブジェクトである。つまり、ゲーム世界上に物体として存在する
- 本仕様書を含め、エネルギーの量を記載する際に数値に `E` をつけて `5E`, `123E` （それぞれエネルギーが5単位、123単位）と表記する

### エージェント

- 「エージェント」とは、相互に結合したユニットの集まりを、人間のために便宜上そう呼んでいるだけであり、ゲームの実装上そのような単位の実装が存在するわけではない
  - ゲーム世界上では、それぞれのユニットが自律して動作し、周囲のユニットや環境と相互作用を行っているだけである

### ユニット[AgentUnit]

- ユニットはゲームオブジェクトである
- 仕様：
  - ユニット生成時に固定される性質と、生成後に再設定可能な性質がある
  - ユニット生成[Assemble]
    - 全てのユニットはASSEMBLERにより、そのユニットを構成するのに必要なエネルギーを消費して生成される
    - ユニット構築に必要なエネルギーの量は、ユニットの種類と仕様によって異なる
      - この仕様は各ユニットの「生産仕様」の項に定義される
        - ユニット生成に要するエネルギーは大部分がそのユニットを構成するのに使われる（ユニット構成エネルギー[Build Energy]）が、その他はユニット生成活動によって消費される（ユニット生産エネルギー[Assemble Energy]）。つまり、ユニットを分解して得られるエネルギーは、そのユニットを生成するのに必要な総エネルギー量（ユニットコスト[Unit Cost]）より常に少なくなる
  - ユニット分解[Disassemble]
    - ユニットはDISASSEMBLERに分解される、または環境ダメージによりダメージを負う
      - 軽微なダメージはASSEMBLERにより、失ったエネルギーを補充することで修復が可能である
      - 一定以上の構成要素を失ったユニットはユニットとしての機能を喪失し、"分解された"状態[Disassembled]となる
      - ユニットが分解されるとユニット断片[UnitFragment]へと変化する
    - あるユニットがどのように分解されるかはユニットの「分解仕様」の項に定義される
  - ユニットはゲームオブジェクトに直接作用しない、ソフトウェアの実行に関わる回路[Circuit]としての性質をもつ（ユニットの「回路仕様」に記載）
  - ユニットはHULLの外側または内側に固定[Attach]することができる。HULLも例外ではない
  - エージェントの身体仕様はユニットの結合状況で表現される
    - ユニットの結合状況は木構造で表現される
  - 基本的な構想として、ユニットが何かの行動を起こそうとして失敗する場合、ソフトウェア的なエラーを返すのではなく、実行はするが意図した結果が得られない、という現象として実現する
- 回路仕様：
  - 回路的に接続しているユニットへはソフトウェア上で情報アクセスおよび指示ができる（物理的に接続していても回路的には接続していない場合もある）
  - それぞれのユニットには、ソフトウェア上で区別をするためのラベルをつけることができる
- ユニットには以下の種別がある
  - HULL
  - ASSEMBLER
  - DISASSEMBLER
  - COMPUTER

#### HULL

- 概要：
  - ゲーム世界の一角を区切ることで、エージェントの身体を形作る。エージェントを細胞に例えるとHULLは細胞膜である
- 仕様：
  - HULLは容量をもち、他のユニットや資源を格納できる
    - HULLの内部に物質が配置される際に、HULLの容量を超える場合はその物質はHULLの外に配置される
  - HULLの中身は広さのない空間（内容物全てが"隣接"しており、内容物のHULLに対する相対速度は常に0の状態）である
    - この性質により、HULLの内部に配置されたASSEMBLERやDISASSEMBLERはHULLとHULLの内部に格納されたユニット全てに対して操作が可能である
    - ゲーム的な観点から、見た目上は広さがあり、それぞれの内容物が重ならずに存在している見た目（細胞の模式図のような）をとる
  - HULLは入れ子にできる
  - HULLには外側と内側がある
  - 回収/放出
    - "隣接"したエネルギーをHULL内に回収できる。また、回収を停止し、HULL内のエネルギーを外部へ放出することもできる
      - エネルギー以外のゲームオブジェクトは能動的に回収/放出はできない。HULL内に存在するユニットやユニット断片が放出されるのは、HULLが完全に破壊（分解された後のdestroyed HULLが破壊された状態）された際である
  - 分離
    - 可変容積HULLは、容積の一部を"分離"することで新たなHULLを生み出すことができる。この操作にエネルギーは消費しない
      - 分離を行う際は、分離する容積と、分離した娘HULL側に移るユニット、内蔵エネルギーを指定する
      - 分離は即座に（次tickには）行われるが、クールダウンタイムがある
- 回路仕様：
  - HULLに接続しているユニットを回路的に接続する
    - accessibilityでアクセスが禁止されている方向へは、回路的に接続していてもアクセスできない
- 生成仕様
  - 固定容積HULL:
    - TODO:
      - ユニット構成エネルギーおよびユニット生産エネルギーを決める。それぞれのエネルギーは容積が大きいほど大きくなる
      - 制約：固定容積のHULLは、自身のユニットコストより大きい容積を持てない（可変容積HULLとの差別化のため）
  - 可変容積HULL:
    - 生成後に容積を増やせる（分離機能を使う以外で減らせはしない）
    - TODO:
      - ユニット構成エネルギーおよびユニット生産エネルギーを決める。それぞれのエネルギーは容積が大きいほど大きくなる
        - 固定容積のHULLより大きなコストがかかる
      - 制約：可変容積のHULLは、自身のユニットコストより大きい容積を持てる（固定容積HULLとの差別化のため）
- 分解仕様：
  - HULLを構成する `ceil(構成エネルギー量 / 2)` 以上のエネルギーが剥ぎ取られると分解する
  - HULLユニットが分解するとdestroyed HULLに変化する。HULLとの差異は以下
    - accessibilityが「双方向のアクセスが可能」状態に固定される
    - 修理されなくなる（ASSEMBLERに修理を指示しても何も起きなくなる）
    - HULLに固定されていたユニットは固定されたまま
    - HULLに格納されていた、固定されていないユニットや資源、マテリアル等は放出される
- API：
  - build energy
    - readonly
    - ユニット構成エネルギー量
  - damage
    - readonly
    - ユニット構成エネルギー量からどれだけのエネルギーを失っているかを表す
  - capacity
    - readonly
    - HULLの容量
  - accessibility
    - 生成時に定義。readonly
    - 回路を通じたアクセスが行えるかどうかを表す。以下のうちのひとつ
      - 外側から内側へのアクセスのみ可能
      - 内側から外側へのアクセスのみ可能
      - 双方向のアクセスが可能
      - アクセスはできない
  - expand
    - 固定容積のHULLから呼び出しても何も起きない
    - expand cooldownが1以上の場合は何も起きない
    - build energyを1容積分増やす
      - damageが同じだけ増えるので、ASSEMBLERにより修理する必要がある
    - expand cooldownを10にする
  - expand cooldown
    - readonly
    - 0以上の整数値
    - tickごとに減る
  - adjacent objects inside
    - HULLの内側に格納されているオブジェクトの一覧
  - adjacent objects outside
    - HULLの外側に"隣接"しているオブジェクトの一覧

#### ASSEMBLER

- 概要：
  - 指定したユニットの生成もしくはユニットの修復を行う
  - ASSEMBLER生成時にassemble対象を指定する単一目的のASSEMBLERと、assemble時に指定できる万能ASSEMBLERの2種類がある
- 仕様：
  - ユニットの生成
    - 指定のユニットを生成する
  - ユニットの修復
    - 指定のユニットの修理を行う。修理とは、そのユニットのダメージを、エネルギーを使って修復することである
    - n 単位のダメージを修復するには n 単位のエネルギーの他に、 `(n * ユニット生産エネルギー / ユニット構成エネルギー) * 1.1` のエネルギーが修理を行うのに必要である
  - 生成、修理の処理順序
    - 原料の回収
      - 生成/修理を開始すると、隣接している空間やHULLから必要なエネルギーを回収する
      - エネルギーが不足していると生成/修理は開始されない
    - 生成/修理
      - 必要なエネルギーが原料格納スペースに揃い次第、生成/修理が開始される
        - 開始された時点で、生成/修理に要するエネルギー（生産であればユニット生産エネルギー）は消費される
      - 生成/修理は完了まで時間がかかる
        - 完了以前にASSEMBLERが破壊された場合、ユニット構成エネルギーが解放される
    - 生成物の設置
      - ユニットを生成する場合はその生産物をどこへ設置するか（あるいは設置せず空間を漂うに任せるか）を選ぶことができる
        - ASSEMBLERがHULLに固定されていない場合、生産物の設置先がないため設置はできない（ASSEMBLERの隣に出現する）
        - ASSEMBLERがHULLに固定されている場合、そのHULL（⭐︎）の内側・外側へ設置可能
          - また、⭐︎に固定されたHULL、⭐︎に格納されているHULL、⭐︎を格納しているHULL、そしてそれらに再帰的に固定/格納/被格納しているHULLの内側・外側へ設置可能
  - 制約
    - ASSEMBLERは扱えるエネルギー量が定まっており、それを超えるエネルギーを要する生産/修理はできない
      - 扱えるエネルギー量（エネルギー容量）は生成時に設定され、エネルギー容量が大きいASSEMBLERほど生成にエネルギーがかかる
    - ASSEMBLER自身のエネルギー容量に対して、生成/修理に必要なエネルギーが小さいほど高速にassembleを完了できる
- 回路仕様：
  - なし
- 生成仕様：
  - 単一目的ASSEMBLER：
    - TODO:
      - ユニット構成エネルギーおよびユニット生産エネルギーを決める。それぞれのエネルギーはエネルギー容量が大きいほど大きくなる
      - 考慮すべき点：自身を複製することが可能であるようにする（ユニット構成エネルギーとユニット生産エネルギーの合計が、エネルギー容量より小さくなるようなエネルギー容量が存在する）
  - 万能ASSEMBLER：
    - TODO:
      - ユニット構成エネルギーおよびユニット生産エネルギーを決める。それぞれのエネルギーはエネルギー容量が大きいほど大きくなる
        - 単一目的ASSEMBLERの10倍以上のコストがかかる
      - 考慮すべき点：自身を複製することが可能であるようにする（ユニット構成エネルギーとユニット生産エネルギーの合計が、エネルギー容量より小さくなるようなエネルギー容量が存在する）
- 分解仕様：
  - ASSEMBLERを構成する `ceil(構成エネルギー量 / 10)` 以上のエネルギーが剥ぎ取られると分解する
  - ASSEMBLERユニットが分解するとdestroyed ASSEMBLERに変化する。ユニットの生成、ユニットの修復は動作しなくなる。格納されていた原料は全て放出される
- API：
  - build energy
    - readonly
    - ユニット構成エネルギー量
  - damage
    - readonly
    - ユニット構成エネルギー量からどれだけのエネルギーを失っているかを表す
  - capacity
    - readonly
    - 扱えるエネルギー量（エネルギー容量）
  - is running
    - `True` で原料のある限りassembleを継続する
      - `True` に設定した際は自動的にis releasing ingredientsが `False` になる
    - `False` で停止
  - is releasing ingredients
    - `True` 格納している原料を放出する
      - 放出速度は回収速度と同じ
      - `True` に設定した際は自動的にis runningが `False` になる
    - `False` 格納している原料はそのまま
  - assemble recipe
    - 生成/修理対象
    - 単一目的ASSEMBLERの場合はreadonly
    - 万能ASSEMBLERの場合は再設定可能
    - 修理のrecipeである場合は修理対象の情報がrecipeに含まれており、ユニット生成のrecipeである場合はそのユニットの生成時の設定と生成後設置場所の情報がrecipeに含まれる
  - adjacent objects
    - "隣接"しているオブジェクトの一覧

#### DISASSEMBLER

- 概要：
  - 指定のターゲットからエネルギーを剥ぎ取る
- 仕様：
  - 指定のターゲットからエネルギーを剥ぎ取る
  - 指定できるターゲット種別はユニットとユニット断片である
  - 実際にターゲットをdisassembleするにはターゲットと接続もしくは隣接している必要がある
    - 接続しているターゲットを指定するにはソフトウェア上でのそのターゲットの識別子により指定する
    - 隣接しているターゲットは直接指定できず、隣接した任意のゲームオブジェクトをdisassembleする、ということになる
  - disassembleを試みるには、disassemble対象を指定し、1以上のエネルギーを投入する必要がある
    - disassemble対象の構造的な強度が投入エネルギーより小さい場合にdisassembleに成功する
      - 強度が投入エネルギー以上である場合はdisassembleに失敗し、投入したエネルギーは消費され熱となる。また、投入エネルギーが強度を大きく上回った場合も、投入エネルギーは全量消費される
      - 同時に複数のDISASSEMBLERからdisassemble対象になった場合は、個々の投入エネルギーが強度を下回っていても、合計の投入エネルギーが強度を上回ればdisassembleされる
  - 剥ぎ取られたエネルギーはdisassemble対象に隣接する空間に出現する
- 回路仕様：
  - なし
- 生成仕様：
  - TODO:
    - ユニット構成エネルギーおよびユニット生産エネルギーを決める
- 分解仕様：
  - DISASSEMBLERを構成する `ceil(構成エネルギー量 / 5)` 以上のエネルギーが剥ぎ取られると分解する
  - DISASSEMBLERユニットが分解するとdestroyed DISASSEMBLERに変化し、動作しなくなる
- API：
  - build energy
    - readonly
    - ユニット構成エネルギー量
  - damage
    - readonly
    - ユニット構成エネルギー量からどれだけのエネルギーを失っているかを表す
  - adjacentObjects
    - "隣接"しているオブジェクトの一覧

#### COMPUTER

- 概要：
  - Synthetica Scriptで記述されたソフトウェアを実行し、回路的に接続しているユニットを制御する
- 仕様：
  - アセンブリ言語であるSynthetica Scriptを解釈し、実行する
  - COMPUTERはプログラムカウンタ、固定bit長のワーキングレジスタ、メモリの3要素から成る
    - つまり、プログラムとデータは分離していない（分離させたい場合は、データ領域にプログラムカウンタが侵入しないようなプログラムにする）
  - COMPUTERの生成時に指定できる性能は以下のふたつである
    - 動作周波数
      - tickあたり何命令を実行できるかを表す（例：10命令/tick）
        - 動作周波数がtickより遅い（例：1命令/3tick）設定も可能
    - メモリ容量
      - メモリの格納容量
  - ワーキングレジスタの内容は、回路で接続した他のユニットからも読み取ることができる
    - "有性生殖"はこの機能により可能となる
  - COMPUTERの動作（命令の実行）にはエネルギーを消費する
- 回路仕様：
  - なし
- 生成仕様：
  - 単一目的COMPUTER
    - プログラムカウンタなし、ワーキングレジスタなし、メモリの変更不可のCOMPUTER
      - 用途の例：ある条件を満たしたらあるユニットを動作させる、あるユニットにマクロ操作を付与する、など
    - TODO:
      - ユニット構成エネルギーおよびユニット生産エネルギーを決める。汎用COMPUTERより大幅に小さなコストとなるようにする
      - 動作周波数を決める（汎用COMPUTERより高速になるようにする）
  - 汎用COMPUTER
    - TODO:
      - ユニット構成エネルギーおよびユニット生産エネルギーを決める。それぞれのエネルギーは動作周波数が高いほど、メモリ容量が大きいほど大きくなる
- 分解仕様：
  - COMPUTERを構成する `ceil(構成エネルギー量 / 20)` 以上のエネルギーが剥ぎ取られると分解する
  - COMPUTERユニットが分解するとdestroyed COMPUTERに変化し、動作しなくなる
- API：
  - build energy
    - readonly
    - ユニット構成エネルギー量
  - damage
    - readonly
    - ユニット構成エネルギー量からどれだけのエネルギーを失っているかを表す
  - adjacentObjects
    - "隣接"しているオブジェクトの一覧

### Synthetica Script

- Synthetica Assembler

### 自己複製エージェント仕様

#### 非生命複製子

- 概要
  - 自身を複製するが、進化の余地がない
- 動作状態の自己複製単一目的ASSEMBLER

#### 受動自律エージェント

- 概要
  - 能動的な活動はせず、条件が整うと自己複製する
- ハードウェア
  - 可変容量HULL
    - 外側
      - なし
    - 内側
      - 万能ASSEMBLER
      - COMPUTER
- ライフサイクル
  - 誕生 → 成長 → 自己複製
- ソフトウェア
  - HULLは常にエネルギー回収状態で固定
  - HULLにダメージがあれば修理する
  - HULL容量が自己複製に必要なエネルギー量に足りない場合はHULLを拡張
  - 自己複製に必要なエネルギーが集まったら、娘個体のASSEMBLERとCOMPUTERを生成 → 娘HULLを分離
