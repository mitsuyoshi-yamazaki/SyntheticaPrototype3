# コミットノート - 25ec58b5ad37cb3c93f996c87b067e48f78a4feb

## ユーザープロンプト

```
TODO.md の 物理演算の詳細仕様化 を実施する

反発係数および摩擦係数は実際に動作させてから調整する

他にこの項について今決定しておくべき内容はあるか
```

続いて：

```
1. 衝突判定の詳細
-> v3系のオブジェクトはすべて円形の形状とする。なので衝突判定はふたつのオブジェクトの中心距離とそれぞれのオブジェクトの半径により求められる。衝突判定の最適化手法はどのようなものがあるか提案せよ
```

続いて：

```
1. 衝突判定の詳細 についてはそれで良い。仕様の記載を始めよ

2. 反発力の計算式 以降はその後実施する
```

続いて：

```
2. 反発力の計算式
-> 重なりが大きいほど反発力が大きく、かつ反発力が上限を持つような式を作れ

3. 速度制限
-> 一旦システム的な速度制限は設けないでおく

4. 質量・慣性の扱い
-> オブジェクトは質量をもち、オブジェクトの運動が変化するのはオブジェクトに力がかかるためである。このことから、自動的に慣性もこのゲームには存在する。回転は扱わない（オブジェクトは回転しない）

5. 境界条件
-> トーラスの上下、左右はそれぞれ接続しているので、そのように扱う。また、トーラスの高さ、幅の半分を超える物体は存在しない想定で良い

6. 処理順序とタイミング
-> 処理の順序に関して特に要望はない。実装の都合で決めて良い。他の仕様とも干渉しないはずである。あるオブジェクトが複数のオブジェクトと衝突状態にあった場合も、単にそれぞれのオブジェクトとの衝突処理を行うだけである（オブジェクトには合成された反発力がかかる）
```

続いて：

```
よろしい。 game-world-requirement.md に関連項目があれば更新し、また physics-system-specification.md への参照を追記せよ
```

続いて：

```
ルートディレクトリのCLAUDE.mdの ユーザー指示を受けてファイルを変更した場合 を実行せよ
```

## 実施内容

物理演算システムの詳細仕様を定義し、関連ファイルを更新しました。

### 1. physics-system-specification.mdの作成

以下の仕様を定義：

#### 1. 衝突判定システム

- 全オブジェクト円形
- 空間分割グリッド（100単位、HULLサイズの2-3倍）
- マンハッタン距離による早期棄却
- 距離の二乗判定で平方根演算を回避
- トーラス境界処理

#### 2. 反発力の計算

- tanh関数による上限付き：`MAX_FORCE × tanh(overlap/SCALE)`
- 重なりが小さい時は線形的、大きい時は上限に漸近
- 完全重複時はランダム方向への反発

#### 3. 速度制限

- システム的な制限なし
- 自然な制約（摩擦、反発力上限）のみ
- 数値エラー防止の緊急制限のみ

#### 4. 質量と慣性

- 質量 = エネルギー量
- F = ma に基づく運動
- 回転なし（v3では扱わない）

#### 5. 境界条件

- トーラス世界の実装
- オブジェクトサイズ < 世界サイズ/2 の前提
- シンプルなラップアラウンド処理

#### 6. 処理順序

- 力の初期化 → 外部力 → 衝突検出 → 反発力 → 運動更新
- 複数衝突は自然に合成
- 1tick内で衝突判定は1回のみ

### 2. game-world-requirement.mdの更新

以下の箇所にphysics-system-specification.mdへの参照を追加：

- ゲームオブジェクトのプロパティ（91行目）：「v3では全て円形」を追記
- 衝突仕様（100行目付近）：詳細仕様への参照を追加
- tick処理の物理演算フェーズ（118行目）：参照を追加

### 3. TODO.mdの更新

- 「物理演算の詳細仕様化（衝突・反発力）」タスクを完了に変更
- 詳細説明を実装内容に更新
