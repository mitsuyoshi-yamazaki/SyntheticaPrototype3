# 自己複製エージェント初期配置 実装計画

## 概要

アプリケーション起動時に、サンプルの自己複製エージェントが配置された状態で開始できるようにする機能を実装する。

## 背景

現在のシステムでは、起動時にエネルギーソースと力場のみが配置され、エージェントは存在しない。
自己複製の動作を確認し、デモンストレーションを行うために、初期状態で自己複製可能なエージェントを配置する必要がある。

## 完了状態

- アプリケーション起動時に、サンプルの自己複製エージェントが配置された状態で開始できるようにする機能を実装する
  - 自己複製エージェントの作成は本タスクに含めない
  - 似た概念の `AgentDefinition` および `WorldConfig.initialAgents` が不要になるため、これらを削除する

## 実装計画

### 1. エージェントプリセットシステム

#### 1.1 型定義

```typescript
// src/engine/presets/types.ts
export interface SingleHullSingleComputerAgentPreset {
  readonly case: "single-hull, single-computer"
  readonly name: string
  readonly description: string
  readonly units: ReadonlyArray<UnitDefinition>
  readonly program: Uint8Array // COMPUTERユニット用プログラム
}

export interface UnitDefinition {
  readonly type: UnitType
  readonly parameters: UnitSpec
  readonly isAttached: boolean // HULLに固定するか
}
```

#### 1.2 自己複製エージェントプリセット

```typescript
// src/engine/presets/self-replicator-preset.ts
export const SELF_REPLICATOR_PRESET: SingleHullSingleComputerAgentPreset = {
  name: "BasicSelfReplicator",
  description: "基本的な自己複製エージェント",
  units: [
    {
      type: "HULL",
      parameters: {
        type: "HULL",
        capacity: 1000,
      },
      isAttached: false,
    },
    {
      type: "ASSEMBLER",
      parameters: {
        type: "ASSEMBLER",
        assemblePower: 10,
      },
      isAttached: true,
    },
    {
      type: "COMPUTER",
      parameters: {
        type: "COMPUTER",
        processingPower: 5,
        memorySize: 512,
      },
      isAttached: true,
    },
  ],
  program: generateSelfReplicatorProgram(),
}

type AgentPreset = SingleHullSingleComputerAgentPreset // 他のpreset型を作成したらここへ追加する
```

### 2. エージェント生成機能の拡張

#### 2.1 AgentFactory

```typescript
// src/engine/agent-factory.ts
export class AgentFactory {
  public static createFromPreset(preset: AgentPreset): Hull {
    // 1. HULLを生成
    // 2. 他のユニットを生成して配置
    // 3. attachedフラグに基づいて接続
    // 4. COMPUTERにプログラムをロード
    // 5. プログラムを開始
  }
}
```

#### 2.2 既存システムとの統合

- `ObjectFactory`を使用してユニットを生成
- `ComputerVMSystem`を使用してプログラムをロード
- `CircuitConnectionSystem`を使用してユニット間を接続

### 3. Worldクラスの拡張

#### 3.1 設定の拡張

```typescript
export interface WorldConfig {
  // 既存のフィールド...

  // 新規追加
  readonly defaultAgentPresets: ReadonlyArray<{
    preset: AgentPreset
    position: Vec2
  }>
}
```

#### 3.1 Agent追加メソッドの追加

- TODO: Worldクラスへ、（実行の途中で）エージェントを追加するメソッド addAgent() を追加する。今回の要件を実現するには、World初期化直後にAgentPresetを作成し、そのメソッドを呼び出すことにより実現する

#### 3.2 初期化処理の修正

```typescript
private initialize(config: WorldConfig): void {
  // エネルギーソースの配置
  this.placeEnergySources()

  // デフォルトエージェントの配置（新規追加）
  if (config.defaultAgentPresets.length > 0) {
    config.defaultAgentPresets.forEach({preset, position} => {
        this.addAgent(AgentFactory.createFromPreset(preset), position)
    })
  }
}
```

### 4. GameWorldクラスの修正

```typescript
// src/lib/GameWorld.ts
export class GameWorld {
  public constructor(width: number, height: number) {
    this._world = new World({
      width,
      height,
      parameters: {
        energySourceCount: 5,
        energySourceMinRate: 50,
        energySourceMaxRate: 150,
        ticksPerFrame: 1,
      },
      defaultAgentPresets: [
        {
          preset: SELF_REPLICATOR_PRESET,
          position: { x: width * 0.3, y: height * 0.5 },
        },
      ],
    })

    // 力場の追加...
  }
}
```

### 5. 実装順序とタスク

1. **既存コードのクリーンアップ**
   - [ ] AgentDefinition型の削除
   - [ ] WorldConfig.initialAgentsの削除
   - [ ] World.addAgent(AgentDefinition)メソッドの削除

2. **プリセットシステム**
   - [ ] 型定義ファイルの作成（SingleHullSingleComputerAgentPreset）
   - [ ] 自己複製エージェントプリセットの実装（プログラムはダミー）
   - [ ] プリセット検証関数の実装

3. **エージェント生成**
   - [ ] AgentFactoryクラスの実装
   - [ ] プリセットからの生成機能
   - [ ] ユニット接続処理

4. **World統合**
   - [ ] World.addAgent(hull: Hull, position: Vec2)メソッドの追加
   - [ ] WorldConfig型の拡張（defaultAgentPresets追加）
   - [ ] 初期化処理の修正（デフォルトエージェント配置）

5. **GameWorld修正**
   - [ ] defaultAgentPresetsの設定追加
   - [ ] 自己複製エージェントの初期配置

6. **テスト**
   - [ ] エージェント生成のテスト
   - [ ] 初期配置の統合テスト

### 7. テスト計画

#### 7.1 単体テスト

- 自己複製プログラムの各命令の動作確認
- プリセットからのエージェント生成
- ユニット間の接続確認

#### 7.2 統合テスト

- 初期配置されたエージェントの起動確認
- 自己複製動作の確認
- エネルギー収集から分離までの一連の流れ

#### 7.3 パフォーマンステスト

- 複数の自己複製エージェントによる負荷確認
- メモリ使用量の監視

### 8. 将来の拡張

- 複数の異なるプリセット（捕食者、協力型など）
- プリセットの外部ファイル化（JSON形式）
- UIからのプリセット選択機能
- プリセットエディタの実装

### 9. リスクと対策

**リスク1：無制限な自己複製**

- 対策：エネルギー制限、空間制限により自然に制御

**リスク2：初期プログラムのバグ**

- 対策：十分なテスト、デバッグモードの実装

**リスク3：パフォーマンス低下**

- 対策：エージェント数の上限設定、最適化

## まとめ

この実装により、アプリケーション起動時から自己複製の動作を観察できるようになり、Syntheticaの核心的な機能をすぐに体験できるようになる。
