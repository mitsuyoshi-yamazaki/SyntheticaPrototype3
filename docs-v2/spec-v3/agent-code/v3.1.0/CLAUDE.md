# CLAUDE.md - v3.1.0 エージェントコード実装ガイド

このディレクトリには、Synthetica仕様バージョン3.1.0に基づくエージェントコードの実装を格納します。

## バージョン3.1.0の新機能

### 1. ビットシフト命令

- **SHL (0xC2)** - 論理左シフト
- **SHR (0xC3)** - 論理右シフト
- **SAR (0xC4)** - 算術右シフト

### 2. スタック操作命令

- **PUSH_A/B/C/D (0x1F-0x22)** - レジスタをスタックにプッシュ
- **POP_A/B/C/D (0x23-0x26)** - スタックからレジスタにポップ
- **MOV_SP (0x27)** - スタックポインタの値を取得
- **SET_SP (0x28)** - スタックポインタを設定

### 3. 条件付き実行命令

- **CMOV_Z (0xC5)** - ゼロフラグがセットされている場合のみ移動
- **CMOV_NZ (0xC6)** - ゼロフラグがクリアされている場合のみ移動
- **CMOV_C (0xC7)** - キャリーフラグがセットされている場合のみ移動
- **CMOV_NC (0xC8)** - キャリーフラグがクリアされている場合のみ移動

### 4. 動的ユニット操作命令

- **UNIT_MEM_WRITE_DYN (0x9B)** - レジスタ指定アドレスへのユニットメモリ書き込み

## v3.0.0からの移行ガイド

### 利点

1. **ビット操作の効率化** - 16bit値の組み立てが簡単に
2. **構造化プログラミング** - スタック操作による関数呼び出しのサポート
3. **条件処理の最適化** - 分岐を減らしてコード効率向上
4. **動的メモリアクセス** - ループ内でのユニット操作が容易に

### 推奨される使用パターン

#### 16bit値の組み立て

```assembly
; 旧方式（v3.0.0）- 複雑な演算が必要
; 新方式（v3.1.0）
MOV A, high_byte
SHL A, 8          ; 上位バイトを左に8ビットシフト
OR A, low_byte    ; 下位バイトと結合
```

#### 関数呼び出し

```assembly
; 引数をスタックに積む
PUSH_A
PUSH_B
CALL function
; 戻り値はAレジスタに
POP_B   ; スタッククリーンアップ
POP_A
```

#### 条件付き処理

```assembly
CMP A, B
CMOV_Z C, D    ; A == Bの場合のみC = D
```

## メモリ管理

### 推奨メモリレイアウト

- **0x0000-0x3FFF**: プログラムコード（16KB）
- **0x4000-0xDFFF**: データ・ヒープ（40KB）
- **0xE000-0xFFFF**: スタック（8KB）

### スタック保護

v3.1.0では物理的なスタック保護機構はありません。以下の対策を推奨：

- スタック境界チェックの実装
- カナリア値による破壊検出
- 再帰深度の制限

詳細は以下を参照：

- `memory-management-best-practices.md`
- `stack-protection-example.c`

## 実装例

このディレクトリには、v3.1.0の新機能を活用した自己複製エージェントの実装例が含まれます。

## 関連ドキュメント

- `/docs/spec-v3/VERSION.md` - バージョン履歴
- `/docs/spec-v3/synthetica-script.md` - 完全な命令セット仕様
- `/docs/spec-v3/advanced-instructions-proposal.md` - 新命令の詳細と背景
- `../v3.0.0/` - v3.0.0実装（参考用）
