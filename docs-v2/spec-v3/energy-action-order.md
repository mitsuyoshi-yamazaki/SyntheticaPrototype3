# エネルギー確保順序とアクション実行順序

## 概要

このドキュメントは、Synthetica v3におけるエネルギー確保およびアクション実行の順序を定義します。複数のユニットが同時に同じリソースへアクセスする場合の競合解決方法を規定します。

## 基本原則

1. **処理順序**: ユニットIDの大きい順（新しいユニットが優先）
2. **エネルギーソース**: 各tickの最初に処理される
3. **適用範囲**: 競合が発生する可能性のあるアクションのみに適用
4. **設計思想**: 長生きの個体に不利になるように設計

## tick処理フロー

各tickは以下の順序で処理されます：

```
1. エネルギーソースによるエネルギー出現
2. 物理演算（移動、衝突判定）
3. 熱拡散
4. ユニットアクション実行（ID降順）
5. エネルギー消費処理
6. 状態更新
```

## エネルギーソース処理

### 処理順序

1. 全エネルギーソースが同時にエネルギーを生成
2. 生成されたエネルギーオブジェクトは即座にゲーム世界に配置される
3. 配置位置に既存のエネルギーオブジェクトがある場合は結合

### 実装詳細

- エネルギーソースの処理順序による差異はない（全て同時処理）
- 生成タイミングの競合は発生しない

## ユニットアクション実行順序

### 対象となるアクション

以下のアクションは競合の可能性があるため、実行順序の影響を受けます：

1. **エネルギー取得（HULL）**
   - 同一エネルギーオブジェクトへの同時アクセス
   - より大きいIDのユニットが優先

2. **ユニット生産（ASSEMBLER）**
   - 同一空間への同時生産
   - より大きいIDのユニットが優先して配置

3. **ユニット分解（DISASSEMBLER）**
   - 同一ターゲットへの同時分解
   - より大きいIDのユニットが優先

4. **移動（MOVER）**
   - 同一座標への同時移動
   - より大きいIDのユニットが優先して移動

### 実行アルゴリズム

```
// 擬似コード
units = getAllUnits()
sortedUnits = sort(units, by: unitId, order: descending)

for unit in sortedUnits:
    if unit.hasAction():
        executeAction(unit)
```

### 競合解決の例

#### エネルギー取得の競合

```
エネルギーオブジェクト: 100E at (50, 50)
HULL[ID: 5]: 取得要求 50E
HULL[ID: 8]: 取得要求 80E

実行順序:
1. HULL[8]が80E取得 → 成功（残り20E）
2. HULL[5]が50E取得 → 部分成功（20Eのみ取得）
```

#### 空間配置の競合

```
座標 (100, 100) に空きスペースあり
ASSEMBLER[ID: 3]: HULL生産
ASSEMBLER[ID: 7]: COMPUTER生産

実行順序:
1. ASSEMBLER[7]がCOMPUTER生産 → 成功
2. ASSEMBLER[3]がHULL生産 → 失敗（空間なし）
```

## 設計意図

### 新しいユニットを優先する理由

1. **進化の促進**
   - 新しい個体（変異体）に有利な環境を提供
   - 古い個体の独占を防ぐ

2. **リソースの循環**
   - 長生きの個体によるリソース独占を防止
   - 新陳代謝を促進

3. **戦略的多様性**
   - 単純な「早い者勝ち」戦略の抑制
   - より複雑な生存戦略の必要性

## 実装における注意事項

### パフォーマンス考慮

- ユニットIDによるソートは各tickで実行
- 大規模な個体数でも効率的に動作するよう実装

### 公平性の確保

- IDの割り当ては生成順に厳密に管理
- IDの再利用は行わない（単調増加）

### デバッグ支援

- 競合発生時のログ出力
- 実行順序の可視化機能

## 将来の拡張

### v4での検討事項

1. 優先度システムの導入
   - ユニット種別による優先度
   - 状態による動的優先度

2. 協調的アクション
   - 複数ユニットの同期実行
   - グループ行動の実装

3. 局所的な順序制御
   - 空間分割による並列処理
   - 近傍ユニットのみでの競合解決

## 関連ドキュメント

- `game-world-requirement.md`: ゲーム世界の基本仕様
- `synthetica-script.md`: 命令実行の詳細
- `energy-definition.md`: エネルギーシステムの定義
