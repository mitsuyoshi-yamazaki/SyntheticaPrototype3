# エネルギー消費仕様

## このファイルについて

本ファイルはSyntheticaPrototype2におけるエネルギー消費に関する仕様をまとめたものです。ユニット種別ごとの操作および、その他の操作によるエネルギー消費の一覧を記載します。

## エネルギー消費の分類

### 1. ユニット生成・分解

#### HULL

- **生成時**
  - 構成エネルギー = `容量 × 2E`
  - 生産エネルギー = `ceil(構成エネルギー × 0.05)`
  - **合計コスト** = 構成エネルギー + 生産エネルギー
  - **例**: 容量100のHULL
    - 構成エネルギー = 100 × 2 = 200E
    - 生産エネルギー = ceil(200 × 0.05) = 10E
    - 合計 = 210E

- **マージ時**
  - エネルギー消費量：仕様書に明記されていないが消費する（TBD）

#### ASSEMBLER

- **生成時**
  - 構成エネルギー = `8000E + (assemble_power × 2000E)` （assemble_powerは1以上）
  - 生産エネルギー = `ceil(構成エネルギー × 0.5)`
  - **例**: assemble_power=5のASSEMBLER
    - 構成エネルギー = 8000 + (5 × 2000) = 18000E
    - 生産エネルギー = ceil(18000 × 0.5) = 9000E
    - 合計 = 27000E

#### DISASSEMBLER

- **生成時**
  - 構成エネルギー = `2000E + (disassemble_power × 200E)`
  - 生産エネルギー = `ceil(構成エネルギー × 0.2)`
  - **例**: disassemble_power=10のDISASSEMBLER
    - 構成エネルギー = 2000 + (10 × 200) = 4000E
    - 生産エネルギー = ceil(4000 × 0.2) = 800E
    - 合計 = 4800E

#### COMPUTER

- **生成時**
  - 構成エネルギー = `500E + ceil((動作周波数 / 5)^2 × 100E) + (メモリ容量 × 50E)`
  - 生産エネルギー = `ceil(構成エネルギー × 0.1)`
  - **例1**: 動作周波数10/tick、メモリ256バイトのCOMPUTER
    - 構成エネルギー = 500 + ceil((10/5)^2 × 100) + (256 × 50)
    - = 500 + ceil(4 × 100) + 12800
    - = 500 + 400 + 12800 = 13700E
    - 生産エネルギー = ceil(13700 × 0.1) = 1370E
    - 合計 = 15070E
  - **例2**: 動作周波数1/tick、メモリ64バイトのCOMPUTER
    - 構成エネルギー = 500 + ceil((1/5)^2 × 100) + (64 × 50)
    - = 500 + ceil(0.04 × 100) + 3200
    - = 500 + 4 + 3200 = 3704E
    - 生産エネルギー = ceil(3704 × 0.1) = 371E
    - 合計 = 4075E

### 2. ユニット操作によるエネルギー消費

#### ASSEMBLER操作

- **ユニット生産処理**
  - 生産中ユニット生成 = `ceil(完成ユニットの構成エネルギー × 0.05)`
  - 生産継続（tickごと）= assemble_powerに比例（詳細な計算式は未定義）
  - **例**: 容量100のHULL生産
    - 生産中ユニット生成 = ceil(200 × 0.05) = 10E
    - 生産継続 = assemble_power量のエネルギーを毎tick消費

- **ユニット修復**
  - 修復エネルギー = `n + (n × ユニット生産エネルギー / ユニット構成エネルギー) × 1.1`
  - **例**: 50Eのダメージを受けたHULLの修復
    - n = 50
    - 修復エネルギー = 50 + (50 × 10 / 200) × 1.1 = 50 + 2.75 = 52.75E → 53E

#### DISASSEMBLER操作

- **分解試行**
  - 最低1E以上を投入（投入量は任意）
  - 成功・失敗に関わらず投入エネルギーは全量消費
  - 成功時：対象から剥ぎ取られたエネルギーが周囲に出現
  - 失敗時：投入エネルギーは熱に変換

#### COMPUTER操作

- **命令実行**（Synthetica Script）
  - 1バイト命令: 1E
  - 3バイト命令: 3E
    - レジスタベース命令: 3E
    - 間接アドレス命令: 4E
  - 4バイト命令: 4E
    - 絶対アドレス命令: 6E
    - レジスタベースユニット操作: 4E + 10E（ユニット操作）
  - 5バイト命令: 5E
    - 即値ロード: 5E
  - テンプレートマッチング:
    - 基本コスト: 3E
    - テンプレート長: length × 0.5E
    - 検索距離: distance × 0.1E
    - 失敗時: 基本コスト + 最大検索距離 × 0.1E
  - ユニット操作命令: +10E 追加

- **動作周波数による基本消費**
  - tickあたり: `動作周波数 × 命令実行エネルギー`
  - **例**: 10命令/tickのCOMPUTERが1バイト命令を実行
    - tickあたり消費 = 10 × 1E = 10E/tick

### 3. 環境によるエネルギー消費

#### 熱ダメージ

- セルの熱が100度を超えた場合
- ダメージ量 = `ceil(熱 - 100)E` per tick
- ユニット状態による倍率:
  - 通常状態: ×1
  - 部分損傷状態（構成エネルギーの50%以下）: ×2
  - 生産中ユニット: ×3
- **例**: 熱150度のセルにいる通常ユニット
  - ダメージ = ceil(150 - 100) = 50E/tick
- **例**: 熱120度のセルにいる生産中ユニット
  - ダメージ = ceil(120 - 100) × 3 = 20 × 3 = 60E/tick

### 4. 物理的相互作用によるエネルギー消費

#### 移動・加速

- ユニットの移動にかかるエネルギー消費の詳細は未定義（TBD）

#### 衝突・反発

- 反発力計算の詳細は未定義（TBD）

### 5. エネルギーの熱変換

全てのエネルギー消費は、消費された場所のセルに熱として加算される:

- 消費エネルギー量 = 発生熱量
- 熱の拡散・放熱は環境処理フェーズで処理

## エネルギー効率の例

### 自己複製エージェントのエネルギー収支

#### 最小構成エージェント（容量100のHULL内にASSEMBLER、COMPUTER）

1. **初期生成コスト**
   - HULL(100): 200 + ceil(200 × 0.05) = 210E
   - ASSEMBLER(power=1): 800 + 200 + ceil(1000 × 0.2) = 1200E
   - COMPUTER(1Hz, 256B): 500 + ceil((1/5)^2 × 100) + (256 × 50) + ceil(13304 × 0.1) = 500 + 4 + 12800 + 1331 = 14635E
   - **合計**: 16045E = 15×1024E + 685E（1024進法表現）

2. **運用時消費**（tickあたり）
   - COMPUTER動作: 1E～6E（命令による）
   - 熱ダメージ: 環境温度による

3. **自己複製コスト**
   - 娘個体生成: 初期生成コストと同等 = 16045E
   - 追加で必要な作業エネルギー: 数百E（メモリコピー等）

### エネルギー源からの収支バランス

- エネルギーソースの産出量: ソースごとに設定（未定義）
- 効率的なエネルギー回収と消費のバランスが生存の鍵

## 未定義項目（TBD）

1. **HULLマージのエネルギーコスト**
2. **ユニット移動のエネルギーコスト**
3. **ASSEMBLERの生産継続時の詳細なエネルギー消費式**
4. **エネルギーソースごとの産出量**
5. **物理的相互作用（衝突等）のエネルギーコスト**

## 備考

- エネルギー消費の失敗（不足）時は、アクション種別ごとに定義された失敗処理が実行される
- エネルギー確保フェーズとアクション実行フェーズは分離されている
- 全てのエネルギー消費は熱として環境に影響を与える

## エネルギー表現の課題と実装済み解決策

### 元の課題

#### 課題1: 16bit制限（最大65,535）

- COMPUTERは16bitアーキテクチャのため、計算で扱うエネルギー量を65,535以内に収めたい
- 元のエネルギー量の例：
  - COMPUTER生成: 164,400E（16bit範囲を超過）
  - 最小構成エージェント: 173,316E（同様に超過）

#### 課題2: 小数回避とCOMPUTER実行コストの精度

- エネルギー消費量は実装の簡便さのため整数にしたい
- COMPUTER実行コスト（0.1E～0.6E）はceil/floorを避けたい
  - 丸め処理を行うと実行周波数によるエネルギーコストの差が出にくくなる
- 全体を10倍にすれば解決するが、課題1と矛盾する

### 実装済みの解決策

**案2（1024進法分割計算方式）** と **案4（コスト見直し）** の組み合わせを実装：

1. **1024進法エネルギー表現**
   - 上位16bit: 1024E単位（2^10）
   - 下位16bit: 1E単位（有効範囲は0-1023）
   - 最大値: 65,535 × 1024 + 1,023 = 67,108,863E

2. **コスト調整**
   - COMPUTERメモリコスト: 500E/B → 50E/B（1/10削減）
   - 各ユニット基本コスト: 1/10削減
   - COMPUTER実行コスト: 1～6E（整数化）
   - 生産中ユニット初期コスト: 10% → 5%

これにより、16bit制限内で広範囲のエネルギー値を扱いつつ、小数を完全に排除した。

### 将来の検討事項

**エネルギーと構造材の分離**は根本的な解決策として有力であり、将来的な実装として検討する価値がある。これにより：

- 概念的により明確（動力 vs 材料）
- ゲームプレイの戦略性向上
- 各資源を独立して16bit範囲内で管理可能
